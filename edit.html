<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Data Peserta - MTQ ke-55</title>
    <link rel="icon" type="image/png" href="logomtq.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #10b981;
            --secondary: #34d399;
            --danger: #ef4444;
            --success: #10b981;
        }

        body {
            font-family: 'Poppins', 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #064e3b 0%, #059669 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 40px 20px;
            color: #1f2937;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(16, 185, 129, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            color: var(--primary);
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 800;
        }

        .header p {
            color: #065f46;
            font-size: 1.1em;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 25px;
        }

        .loading-container {
            text-align: center;
            padding: 60px 40px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 5px solid rgba(16, 185, 129, 0.2);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--primary);
            font-size: 1.2em;
            font-weight: 600;
        }

        .error-container {
            text-align: center;
            padding: 60px 40px;
        }

        .error-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .error-title {
            color: var(--danger);
            font-size: 2em;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .error-message {
            color: #666;
            font-size: 1.1em;
            line-height: 1.8;
        }

        .info-section {
            background: linear-gradient(135deg, rgba(240, 253, 244, 0.8), rgba(220, 252, 231, 0.8));
            border-left: 5px solid var(--primary);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .info-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .info-row {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 15px;
            margin-bottom: 12px;
            align-items: start;
        }

        .info-label {
            font-weight: 700;
            color: var(--primary);
        }

        .info-value {
            color: #065f46;
            word-break: break-word;
        }

        .form-section {
            margin-top: 35px;
        }

        .section-title {
            color: var(--primary);
            font-size: 1.5em;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--primary);
            font-weight: 700;
            font-size: 1em;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(5, 150, 105, 0.2);
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
            transform: translateY(-2px);
            background: white;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .file-upload-group {
            margin-bottom: 25px;
        }

        .file-upload-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary);
            font-weight: 700;
        }

        .file-upload-group small {
            display: block;
            margin-bottom: 12px;
            color: #666;
            font-size: 0.85em;
        }

        .file-upload-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: nowrap;
        }

        .btn-file {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 25px;
            height: 48px;
            background: linear-gradient(135deg, #34d399, #10b981);
            color: white;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1em;
            white-space: nowrap;
            border: none;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .btn-file:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-clear {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 25px;
            height: 48px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1em;
            white-space: nowrap;
            border: none;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .btn-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .file-name {
            color: #666;
            font-weight: 600;
            display: block;
            margin-top: 10px;
            word-break: break-word;
        }

        .file-name.uploaded {
            color: var(--success);
        }

        .current-file {
            background: rgba(16, 185, 129, 0.1);
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .current-file-label {
            font-size: 0.85em;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .current-file-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            word-break: break-all;
        }

        .current-file-link:hover {
            text-decoration: underline;
        }

        .btn-submit {
            padding: 18px 40px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            cursor: pointer;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
            width: 100%;
            margin-top: 20px;
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(5, 150, 105, 0.4);
        }

        .btn-submit:disabled {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid;
        }

        .alert-warning {
            background: linear-gradient(135deg, rgba(254, 243, 199, 0.9), rgba(253, 230, 138, 0.9));
            border-color: #f59e0b;
            color: #92400e;
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(224, 242, 254, 0.9), rgba(186, 230, 253, 0.9));
            border-color: #3b82f6;
            color: #1e40af;
        }

        .member-section {
            background: linear-gradient(135deg, rgba(240, 253, 244, 0.5), rgba(220, 252, 231, 0.5));
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .member-section h4 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(6, 78, 59, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-overlay .loading-content {
            text-align: center;
            color: white;
        }

        .loading-overlay .loading-spinner {
            width: 80px;
            height: 80px;
            border-width: 7px;
        }

        .loading-overlay .loading-text {
            color: white;
            font-size: 1.3em;
            margin-top: 20px;
        }

        .result-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(6, 78, 59, 0.9);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            align-items: center;
            justify-content: center;
        }

        .result-modal.show {
            display: flex;
        }

        .result-content {
            background: rgba(255, 255, 255, 0.98);
            -webkit-backdrop-filter: blur(30px);
            backdrop-filter: blur(30px);
            padding: 50px;
            border-radius: 30px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .result-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .result-message {
            font-size: 1em;
            color: #555;
            line-height: 1.8;
            margin-bottom: 25px;
        }

        .result-content button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .result-content button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .header, .card {
                padding: 30px 25px;
                border-radius: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .info-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .file-upload-controls {
                flex-wrap: wrap;
            }

            .btn-file, .btn-clear {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 20px 10px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 1em;
            }

            .result-content {
                padding: 35px 25px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text" id="loadingText">Memproses...</p>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="result-modal">
        <div class="result-content">
            <div class="result-icon" id="resultIcon"></div>
            <div class="result-title" id="resultTitle"></div>
            <div class="result-message" id="resultMessage"></div>
            <button onclick="closeResultModal()">Tutup</button>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚úèÔ∏è Edit Data Peserta</h1>
            <p>MTQ ke-55 Kabupaten Indramayu 2025</p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="card">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p class="loading-text">Memuat data peserta...</p>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="card" style="display: none;">
            <div class="error-container">
                <div class="error-icon">‚ö†Ô∏è</div>
                <div class="error-title">Data Tidak Ditemukan</div>
                <div class="error-message" id="errorMessage">
                    Nomor peserta tidak valid atau data tidak ditemukan di sistem.
                </div>
            </div>
        </div>

        <!-- Content State -->
        <div id="contentState" style="display: none;">
            <!-- Info Peserta -->
            <div class="card">
                <div class="info-section">
                    <h3>üìã Informasi Peserta</h3>
                    <div class="info-row">
                        <span class="info-label">Nomor Peserta:</span>
                        <span class="info-value" id="infoNomorPeserta">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Cabang Lomba:</span>
                        <span class="info-value" id="infoCabang">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Kecamatan:</span>
                        <span class="info-value" id="infoKecamatan">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="infoStatus">-</span>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Perhatian:</strong> Anda hanya dapat mengubah NIK, Nama Lengkap, dan dokumen pendukung. Data lainnya tidak dapat diubah melalui halaman ini.
                </div>
            </div>

            <!-- Form Edit -->
            <div class="card">
                <form id="editForm">
                    <input type="hidden" id="nomorPeserta" name="nomorPeserta">
                    <input type="hidden" id="rowIndex" name="rowIndex">
                    <input type="hidden" id="isTeam" name="isTeam">

                    <!-- Personal/Team Content akan di-inject di sini -->
                    <div id="formContent"></div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn-submit" id="submitBtn">
                        üíæ Simpan Perubahan
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGiDuz-tQYpAWwSW3vqB3Sa3JRkUeTJ7vvaHG7p9nz1JArINxwGUMpHoVVw1f0eqJ3/exec';
        const MAX_FILE_SIZE_MB = 5;
        const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

        let pesertaData = null;
        let uploadedFiles = {};

        // ===== DECODE NOMOR PESERTA FROM URL =====
        function getNomorPesertaFromURL() {
            // Try to get from hash first (for edit.html#xxx format)
            let encodedPart = window.location.hash.replace('#', '').trim();
            
            // If no hash, try from pathname (for 404.html with /xxx format)
            if (!encodedPart) {
                const path = window.location.pathname;
                const segments = path.split('/').filter(s => s); // Remove empty segments
                encodedPart = segments[segments.length - 1];
                
                // Skip if it's a file name or empty
                if (!encodedPart || encodedPart.includes('.html')) {
                    console.error('No valid encoded part found in URL');
                    return null;
                }
            }

            try {
                console.log('Encoded part:', encodedPart);
                
                // Decode base64
                const decoded = atob(encodedPart);
                console.log('Decoded string:', decoded);
                
                // Format: "peserta-XXX"
                if (decoded.startsWith('peserta-')) {
                    const nomorPeserta = decoded.replace('peserta-', '');
                    console.log('Nomor peserta extracted:', nomorPeserta);
                    return nomorPeserta;
                }
                
                console.error('Invalid format: does not start with "peserta-"');
                return null;
            } catch (e) {
                console.error('Decode error:', e);
                console.error('Failed to decode:', encodedPart);
                return null;
            }
        }

        // ===== LOAD PESERTA DATA =====
        async function loadPesertaData(nomorPeserta) {
            try {
                console.log('Loading data for:', nomorPeserta);
                
                // Fetch all data
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getData`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'Gagal mengambil data');
                }

                // Find peserta by nomor peserta
                const nomorPesertaIdx = result.headers.indexOf('Nomor Peserta');
                
                if (nomorPesertaIdx === -1) {
                    throw new Error('Header tidak valid');
                }

                let foundRow = null;
                let foundIndex = -1;

                for (let i = 0; i < result.data.length; i++) {
                    const rowNomorPeserta = result.data[i][nomorPesertaIdx]?.toString().trim();
                    
                    if (rowNomorPeserta === nomorPeserta.trim()) {
                        foundRow = result.data[i];
                        foundIndex = i;
                        break;
                    }
                }

                if (!foundRow) {
                    throw new Error('Nomor peserta tidak ditemukan');
                }

                // Map data
                pesertaData = {
                    rowIndex: foundIndex,
                    headers: result.headers,
                    data: foundRow,
                    nomorPeserta: nomorPeserta
                };

                console.log('Data loaded:', pesertaData);
                return pesertaData;

            } catch (error) {
                console.error('Error loading data:', error);
                throw error;
            }
        }

        // ===== RENDER FORM =====
        function renderForm() {
            const data = pesertaData.data;
            const headers = pesertaData.headers;

            // Get indices
            const cabangIdx = headers.indexOf('Cabang Lomba');
            const kecamatanIdx = headers.indexOf('Kecamatan');
            const statusIdx = headers.indexOf('Status');
            const namaReguIdx = headers.indexOf('Nama Regu/Tim');

            // Update info section
            document.getElementById('infoNomorPeserta').textContent = pesertaData.nomorPeserta;
            document.getElementById('infoCabang').textContent = data[cabangIdx] || '-';
            document.getElementById('infoKecamatan').textContent = data[kecamatanIdx] || '-';
            document.getElementById('infoStatus').textContent = data[statusIdx] || 'Menunggu Verifikasi';

            // Set hidden fields
            document.getElementById('nomorPeserta').value = pesertaData.nomorPeserta;
            document.getElementById('rowIndex').value = pesertaData.rowIndex;

            // Determine if team or personal
            const namaRegu = data[namaReguIdx];
            const isTeam = namaRegu && namaRegu !== '-' && namaRegu.trim() !== '';

            document.getElementById('isTeam').value = isTeam ? 'true' : 'false';

            const formContent = document.getElementById('formContent');

            if (isTeam) {
                formContent.innerHTML = renderTeamForm();
                populateTeamData();
            } else {
                formContent.innerHTML = renderPersonalForm();
                populatePersonalData();
            }

            setupFileInputs();
        }

        // ===== RENDER PERSONAL FORM =====
        function renderPersonalForm() {
            return `
                <h3 class="section-title">üìù Data Pribadi</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label>NIK *</label>
                        <input type="text" name="nik" id="nik" maxlength="16" required>
                    </div>
                    <div class="form-group">
                        <label>Nama Lengkap *</label>
                        <input type="text" name="nama" id="nama" required>
                    </div>
                </div>

                <h3 class="section-title" style="margin-top: 40px;">üìÑ Dokumen Persyaratan</h3>

                ${renderPersonalFileInputs()}
            `;
        }

        function renderPersonalFileInputs() {
            const docs = [
                { num: 1, name: 'Surat Mandat', desc: 'Ditandatangani oleh Ketua LPTQ Kecamatan' },
                { num: 2, name: 'KTP/KK/KIA', desc: 'Diterbitkan maksimal 6 bulan sebelum 1 Nov 2025' },
                { num: 3, name: 'Sertifikat Kejuaraan', desc: 'Dari MTQ Tingkat Kecamatan (Opsional)' },
                { num: 4, name: 'Foto Buku Tabungan', desc: 'Menunjukkan nomor rekening (Opsional)' },
                { num: 5, name: 'Pas Photo Terbaru', desc: 'Latar belakang biru' }
            ];

            return docs.map(doc => `
                <div class="file-upload-group">
                    <label>${doc.num}. ${doc.name}</label>
                    <small>${doc.desc}</small>
                    <div id="currentDoc${doc.num}"></div>
                    <div class="file-upload-controls">
                        <label for="doc${doc.num}" class="btn-file">üìÅ Pilih File Baru</label>
                        <button type="button" class="btn-clear" id="clearDoc${doc.num}" style="display: none;">üóëÔ∏è Hapus</button>
                    </div>
                    <input type="file" id="doc${doc.num}" name="doc${doc.num}" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                    <span class="file-name" id="doc${doc.num}Name">Belum ada file baru</span>
                </div>
            `).join('');
        }

        // ===== RENDER TEAM FORM =====
        function renderTeamForm() {
            return `
                <h3 class="section-title">üë• Data Tim/Regu</h3>

                <div class="form-group">
                    <label>Nama Regu/Tim *</label>
                    <input type="text" name="namaRegu" id="namaRegu" required>
                </div>

                ${renderTeamMember(1)}
                ${renderTeamMember(2)}
                ${renderTeamMember(3)}
            `;
        }

        function renderTeamMember(num) {
            return `
                <div class="member-section">
                    <h4>Anggota Tim #${num}</h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label>NIK ${num <= 2 ? '*' : ''}</label>
                            <input type="text" name="memberNik${num}" id="memberNik${num}" maxlength="16" ${num <= 2 ? 'required' : ''}>
                        </div>
                        <div class="form-group">
                            <label>Nama Lengkap ${num <= 2 ? '*' : ''}</label>
                            <input type="text" name="memberName${num}" id="memberName${num}" ${num <= 2 ? 'required' : ''}>
                        </div>
                    </div>

                    <h4 style="margin-top: 25px;">üìÑ Dokumen Anggota #${num}</h4>
                    ${renderTeamMemberFileInputs(num)}
                </div>
            `;
        }

        function renderTeamMemberFileInputs(memberNum) {
            const docs = [
                { num: 1, name: 'Surat Mandat', desc: 'Ditandatangani oleh Ketua LPTQ Kecamatan' },
                { num: 2, name: 'KTP/KK/KIA', desc: 'Diterbitkan maksimal 6 bulan sebelum 1 Nov 2025' },
                { num: 3, name: 'Sertifikat Kejuaraan', desc: 'Dari MTQ Tingkat Kecamatan (Opsional)' },
                { num: 4, name: 'Foto Buku Tabungan', desc: 'Menunjukkan nomor rekening (Opsional)' },
                { num: 5, name: 'Pas Photo Terbaru', desc: 'Latar belakang biru' }
            ];

            return docs.map(doc => `
                <div class="file-upload-group">
                    <label>${doc.num}. ${doc.name}</label>
                    <small>${doc.desc}</small>
                    <div id="currentTeamDoc${memberNum}_${doc.num}"></div>
                    <div class="file-upload-controls">
                        <label for="teamDoc${memberNum}_${doc.num}" class="btn-file">üìÅ Pilih File Baru</label>
                        <button type="button" class="btn-clear" id="clearTeamDoc${memberNum}_${doc.num}" style="display: none;">üóëÔ∏è Hapus</button>
                    </div>
                    <input type="file" id="teamDoc${memberNum}_${doc.num}" name="teamDoc${memberNum}_${doc.num}" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                    <span class="file-name" id="teamDoc${memberNum}_${doc.num}Name">Belum ada file baru</span>
                </div>
            `).join('');
        }

        // ===== POPULATE PERSONAL DATA =====
        function populatePersonalData() {
            const data = pesertaData.data;
            const headers = pesertaData.headers;

            const getValue = (headerName) => {
                const idx = headers.indexOf(headerName);
                return idx !== -1 ? (data[idx] || '') : '';
            };

            document.getElementById('nik').value = getValue('NIK');
            document.getElementById('nama').value = getValue('Nama Lengkap');

            // Show current files
            for (let i = 1; i <= 5; i++) {
                const fileLink = getValue(`Link - Doc ${getDocName(i)} Personal`);
                if (fileLink && fileLink !== '-' && fileLink.trim() !== '') {
                    showCurrentFile(`currentDoc${i}`, fileLink);
                }
            }
        }

        // ===== POPULATE TEAM DATA =====
        function populateTeamData() {
            const data = pesertaData.data;
            const headers = pesertaData.headers;

            const getValue = (headerName) => {
                const idx = headers.indexOf(headerName);
                return idx !== -1 ? (data[idx] || '') : '';
            };

            document.getElementById('namaRegu').value = getValue('Nama Regu/Tim');

            // Populate members
            for (let i = 1; i <= 3; i++) {
                const nikEl = document.getElementById(`memberNik${i}`);
                const nameEl = document.getElementById(`memberName${i}`);
                
                if (nikEl) nikEl.value = getValue(`Anggota Tim #${i} - NIK`);
                if (nameEl) nameEl.value = getValue(`Anggota Tim #${i} - Nama`);

                // Show current files
                for (let d = 1; d <= 5; d++) {
                    const fileLink = getValue(`Link - Doc ${getDocName(d)} Team ${i}`);
                    if (fileLink && fileLink !== '-' && fileLink.trim() !== '') {
                        showCurrentFile(`currentTeamDoc${i}_${d}`, fileLink);
                    }
                }
            }
        }

        function getDocName(num) {
            const names = {
                1: 'Surat Mandat',
                2: 'KTP',
                3: 'Sertifikat',
                4: 'Rekening',
                5: 'Pas Photo'
            };
            return names[num] || '';
        }

        function showCurrentFile(containerId, fileLink) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="current-file">
                        <div class="current-file-label">üîç File saat ini:</div>
                        <a href="${fileLink}" target="_blank" class="current-file-link">Lihat Dokumen</a>
                    </div>
                `;
            }
        }

        // ===== SETUP FILE INPUTS =====
        function setupFileInputs() {
            const isTeam = document.getElementById('isTeam').value === 'true';

            if (isTeam) {
                // Team file inputs
                for (let i = 1; i <= 3; i++) {
                    for (let d = 1; d <= 5; d++) {
                        setupFileInput(`teamDoc${i}_${d}`, `clearTeamDoc${i}_${d}`);
                    }
                }
            } else {
                // Personal file inputs
                for (let i = 1; i <= 5; i++) {
                    setupFileInput(`doc${i}`, `clearDoc${i}`);
                }
            }
        }

        function setupFileInput(inputId, clearBtnId) {
            const input = document.getElementById(inputId);
            const clearBtn = document.getElementById(clearBtnId);
            const label = document.getElementById(`${inputId}Name`);

            if (!input || !clearBtn || !label) return;

            input.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    const file = this.files[0];

                    // Check file size
                    if (file.size > MAX_FILE_SIZE_BYTES) {
                        label.textContent = `File terlalu besar (${(file.size / 1024 / 1024).toFixed(2)} MB > ${MAX_FILE_SIZE_MB} MB)`;
                        label.style.color = '#ef4444';
                        input.value = '';
                        clearBtn.style.display = 'none';
                        delete uploadedFiles[inputId];
                        return;
                    }

                    label.textContent = file.name;
                    label.classList.add('uploaded');
                    clearBtn.style.display = 'inline-flex';
                    uploadedFiles[inputId] = file;
                } else {
                    if (uploadedFiles[inputId]) {
                        label.textContent = uploadedFiles[inputId].name;
                        label.classList.add('uploaded');
                        clearBtn.style.display = 'inline-flex';
                    } else {
                        label.textContent = 'Belum ada file baru';
                        label.classList.remove('uploaded');
                        clearBtn.style.display = 'none';
                    }
                }
            });

            clearBtn.addEventListener('click', function() {
                input.value = '';
                label.textContent = 'Belum ada file baru';
                label.classList.remove('uploaded');
                clearBtn.style.display = 'none';
                delete uploadedFiles[inputId];
            });
        }

        // ===== FORM SUBMISSION =====
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('editForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                try {
                    showLoadingOverlay(true, 'Menyimpan perubahan...');

                    const formData = new FormData();
                    formData.append('action', 'updateRow');
                    formData.append('rowIndex', pesertaData.rowIndex);
                    formData.append('nomorPeserta', pesertaData.nomorPeserta);

                    const updatedData = {};
                    const isTeam = document.getElementById('isTeam').value === 'true';

                    if (isTeam) {
                        // Collect team data
                        updatedData['Nama Regu/Tim'] = document.getElementById('namaRegu').value;

                        for (let i = 1; i <= 3; i++) {
                            const nik = document.getElementById(`memberNik${i}`)?.value;
                            if (nik) {
                                updatedData[`Anggota Tim #${i} - NIK`] = nik;
                                updatedData[`Anggota Tim #${i} - Nama`] = document.getElementById(`memberName${i}`).value;
                            }
                        }
                    } else {
                        // Collect personal data
                        updatedData['NIK'] = document.getElementById('nik').value;
                        updatedData['Nama Lengkap'] = document.getElementById('nama').value;
                    }

                    formData.append('updatedData', JSON.stringify(updatedData));

                    // Send data update first
                    console.log('Sending data update...');
                    const dataResponse = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    });

                    const dataResult = await dataResponse.json();

                    if (!dataResult.success) {
                        throw new Error(dataResult.message || 'Gagal menyimpan data');
                    }

                    // Upload files if any
                    if (Object.keys(uploadedFiles).length > 0) {
                        showLoadingOverlay(true, 'Mengupload dokumen...');
                        
                        const fileFormData = new FormData();
                        fileFormData.append('action', 'uploadFiles');
                        fileFormData.append('nomorPeserta', pesertaData.nomorPeserta);

                        for (let key in uploadedFiles) {
                            const file = uploadedFiles[key];
                            const base64 = await fileToBase64(file);
                            fileFormData.append(key, base64);
                            fileFormData.append(key + '_name', file.name);
                            fileFormData.append(key + '_type', file.type);
                        }

                        console.log('Uploading files...');
                        const fileResponse = await fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            body: fileFormData
                        });

                        const fileResult = await fileResponse.json();

                        if (!fileResult.success) {
                            console.error('File upload warning:', fileResult.message);
                        }
                    }

                    showLoadingOverlay(false);
                    showResultModal(true, 'Berhasil!', 'Perubahan data telah disimpan.');

                } catch (error) {
                    console.error('Submit error:', error);
                    showLoadingOverlay(false);
                    showResultModal(false, 'Kesalahan', error.message || 'Terjadi kesalahan saat menyimpan data.');
                }
            });
        });

        // ===== HELPER FUNCTIONS =====
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        function showLoadingOverlay(show, text = 'Memproses...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (show) {
                loadingText.textContent = text;
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        function showResultModal(success, title, message) {
            const modal = document.getElementById('resultModal');
            const icon = document.getElementById('resultIcon');
            const titleEl = document.getElementById('resultTitle');
            const messageEl = document.getElementById('resultMessage');

            icon.textContent = success ? '‚úÖ' : '‚ùå';
            titleEl.textContent = title;
            messageEl.textContent = message;

            modal.classList.add('show');
        }

        function closeResultModal() {
            document.getElementById('resultModal').classList.remove('show');
            if (document.getElementById('resultIcon').textContent === '‚úÖ') {
                // Reload page on success
                window.location.href = './';
            }
        }

        // ===== INITIALIZE =====
        async function init() {
            try {
                const nomorPeserta = getNomorPesertaFromURL();

                if (!nomorPeserta) {
                    throw new Error('URL tidak valid.');
                }

                console.log('Nomor Peserta:', nomorPeserta);

                await loadPesertaData(nomorPeserta);

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('contentState').style.display = 'block';

                renderForm();

            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // Run on page load
        init();

    </script>
</body>
</html>